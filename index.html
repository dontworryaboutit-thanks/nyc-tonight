<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYC Tonight</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #faf9f7;
      --surface: #ffffff;
      --text: #1a1a1a;
      --text-secondary: #666;
      --text-muted: #999;
      --accent: #e85d3a;
      --accent-soft: #fef0ec;
      --border: #eee;
      --music-tag: #6c5ce7;
      --music-tag-bg: #f0eeff;
      --cultural-tag: #e17055;
      --cultural-tag-bg: #fef0ec;
      --shadow-hover: 0 4px 12px rgba(0,0,0,0.1), 0 8px 24px rgba(0,0,0,0.06);
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg); color: var(--text); line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    header {
      background: var(--surface); border-bottom: 1px solid var(--border);
      padding: 2rem 0 1.5rem; position: sticky; top: 0; z-index: 100;
    }
    .header-inner { max-width: 1200px; margin: 0 auto; padding: 0 1.5rem; }
    h1 {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 2.2rem; font-weight: 400; letter-spacing: -0.02em;
    }
    .subtitle { color: var(--text-secondary); font-size: 0.95rem; margin-top: 0.25rem; }
    .controls { display: flex; align-items: center; justify-content: space-between; margin-top: 1rem; }
    .filters { display: flex; gap: 0.5rem; }
    .filter-btn {
      padding: 0.4rem 1rem; border: 1px solid var(--border); border-radius: 20px;
      background: var(--surface); color: var(--text-secondary); font-size: 0.85rem;
      font-family: inherit; cursor: pointer; transition: all 0.15s;
    }
    .filter-btn:hover { border-color: var(--text-muted); }
    .filter-btn.active { background: var(--text); color: var(--surface); border-color: var(--text); }
    .refresh-btn {
      width: 36px; height: 36px; border: 1px solid var(--border); border-radius: 50%;
      background: var(--surface); font-size: 1.1rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .refresh-btn:hover { border-color: var(--text-muted); transform: rotate(90deg); }
    .refresh-btn.spinning { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    main { max-width: 1200px; margin: 0 auto; padding: 1.5rem; min-height: 60vh; }

    .profile-bar {
      display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem; padding: 1rem;
      background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border);
    }
    .profile-bar:empty { display: none; }
    .profile-chip {
      display: inline-flex; align-items: center; padding: 0.2rem 0.6rem;
      background: var(--accent-soft); color: var(--accent); border-radius: 12px;
      font-size: 0.75rem; font-weight: 500;
    }
    .profile-bar .label {
      font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.05em; display: flex; align-items: center; margin-right: 0.5rem;
    }
    .status-bar {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem;
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
      font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1.5rem;
    }
    .status-bar.hidden { display: none; }
    .loading-dot {
      width: 8px; height: 8px; background: var(--accent); border-radius: 50%;
      animation: pulse 1.5s ease infinite; flex-shrink: 0;
    }
    @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

    .progress-bar {
      width: 100%; height: 3px; background: var(--border); border-radius: 2px;
      margin-top: 0.5rem; overflow: hidden;
    }
    .progress-fill {
      height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s;
    }

    .events-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.25rem;
    }
    .event-card {
      background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
      overflow: hidden; transition: all 0.2s ease; cursor: pointer; text-decoration: none;
      color: inherit; display: flex; flex-direction: column;
    }
    .event-card:hover { box-shadow: var(--shadow-hover); transform: translateY(-2px); }
    .card-image {
      width: 100%; height: 180px; object-fit: cover;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .card-image.placeholder {
      display: flex; align-items: center; justify-content: center;
      font-size: 2.5rem; color: rgba(255,255,255,0.7);
    }
    .card-body { padding: 1.25rem; flex: 1; display: flex; flex-direction: column; }
    .card-meta { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.6rem; flex-wrap: wrap; }
    .type-tag {
      padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem;
      font-weight: 600; text-transform: uppercase; letter-spacing: 0.04em;
    }
    .type-tag.music { background: var(--music-tag-bg); color: var(--music-tag); }
    .type-tag.cultural { background: var(--cultural-tag-bg); color: var(--cultural-tag); }
    .card-date { font-size: 0.8rem; color: var(--text-muted); }
    .card-title {
      font-family: 'Instrument Serif', Georgia, serif; font-size: 1.25rem;
      font-weight: 400; line-height: 1.3; margin-bottom: 0.5rem;
    }
    .card-venue { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
    .card-description { font-size: 0.85rem; color: var(--text-muted); line-height: 1.5; flex: 1; }
    .card-footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.75rem 1.25rem; border-top: 1px solid var(--border); background: #fafafa;
    }
    .match-reasons { display: flex; flex-wrap: wrap; gap: 0.3rem; }
    .reason-tag {
      font-size: 0.7rem; color: var(--accent); background: var(--accent-soft);
      padding: 0.15rem 0.5rem; border-radius: 8px;
    }
    .source-tag { font-size: 0.7rem; color: var(--text-muted); }
    .score-bar { width: 40px; height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
    .score-fill { height: 100%; background: var(--accent); border-radius: 2px; }

    .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); font-size: 1.1rem; }
    footer {
      text-align: center; padding: 3rem 1.5rem; color: var(--text-muted); font-size: 0.8rem;
      border-top: 1px solid var(--border); margin-top: 3rem;
    }
    footer a { color: var(--text-secondary); }

    @media (max-width: 720px) {
      h1 { font-size: 1.6rem; }
      .events-grid { grid-template-columns: 1fr; }
      .card-image { height: 140px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <h1>NYC Tonight</h1>
      <p class="subtitle">Your personal guide to what's happening in New York</p>
      <div class="controls">
        <div class="filters">
          <button class="filter-btn active" data-filter="all">All</button>
          <button class="filter-btn" data-filter="music">Music</button>
          <button class="filter-btn" data-filter="cultural">Talks &amp; Culture</button>
        </div>
        <button class="refresh-btn" id="refreshBtn" title="Refresh events">&#x21bb;</button>
      </div>
    </div>
  </header>

  <main>
    <div class="profile-bar" id="profileBar"></div>
    <div class="status-bar" id="statusBar">
      <span class="loading-dot"></span>
      <div>
        <span id="statusText">Loading your taste profile...</span>
        <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
      </div>
    </div>
    <div class="events-grid" id="eventsGrid"></div>
    <div class="empty-state" id="emptyState" style="display:none">
      <p>No events found right now. Hit refresh to try again.</p>
    </div>
  </main>

  <footer>
    <p>Powered by your Spotify listening history &middot; Concert data from <a href="https://bandsintown.com" target="_blank">Bandsintown</a></p>
  </footer>

<script>
// ── Config ──────────────────────────────────────────────────────────
const BANDSINTOWN_APP_ID = 'nyc-tonight';
const ARTIST_BATCH_SIZE = 10;
const ARTIST_LIMIT = 80;
const BATCH_DELAY_MS = 300;

// ── State ───────────────────────────────────────────────────────────
let profile = null;
let allEvents = [];
let currentFilter = 'all';

const grid = document.getElementById('eventsGrid');
const statusBar = document.getElementById('statusBar');
const statusText = document.getElementById('statusText');
const progressFill = document.getElementById('progressFill');
const profileBar = document.getElementById('profileBar');
const emptyState = document.getElementById('emptyState');
const refreshBtn = document.getElementById('refreshBtn');

// ── Taste Profile ───────────────────────────────────────────────────
async function loadProfile() {
  const res = await fetch('taste-profile.json');
  profile = await res.json();
  profile.artistSet = new Set(profile.artistNames.map(n => n.toLowerCase()));

  profileBar.innerHTML = `
    <span class="label">Your taste</span>
    ${profile.topArtists.slice(0, 12).map(a =>
      `<span class="profile-chip">${a.name}</span>`
    ).join('')}
  `;
}

// ── Scoring ─────────────────────────────────────────────────────────
function scoreEvent(event) {
  let score = 0;
  const reasons = [];

  const title = (event.title || '').toLowerCase();
  const description = (event.description || '').toLowerCase();
  const artist = (event.artist || '').toLowerCase();
  const combined = `${title} ${description} ${artist}`;

  if (artist && profile.artistSet.has(artist)) {
    const match = profile.topArtists.find(a => a.name.toLowerCase() === artist);
    score += 50 + ((match ? match.score : 0.1) * 50);
    reasons.push(`You listen to ${event.artist}`);
  }

  for (const a of profile.topArtists.slice(0, 200)) {
    const al = a.name.toLowerCase();
    if (al.length > 3 && combined.includes(al) && al !== artist) {
      score += 30 + (a.score * 20);
      reasons.push(`Features ${a.name}`);
      break;
    }
  }

  let keywordHits = 0;
  for (const kw of profile.keywords) {
    if (combined.includes(kw)) keywordHits++;
  }
  if (keywordHits > 0) {
    score += Math.min(keywordHits * 3, 20);
    if (keywordHits >= 3) reasons.push('Matches your interests');
  }
  if (/\b(free|no cover|donation)\b/i.test(combined)) {
    score += 3;
    reasons.push('Free');
  }

  return { ...event, score, reasons };
}

// ── Bandsintown Scraper ─────────────────────────────────────────────
async function fetchArtistEvents(artistName) {
  const encoded = encodeURIComponent(artistName);
  const url = `https://rest.bandsintown.com/artists/${encoded}/events?app_id=${BANDSINTOWN_APP_ID}&date=upcoming`;

  try {
    const res = await fetch(url);
    if (!res.ok) return [];
    const data = await res.json();
    if (!Array.isArray(data)) return [];

    return data.filter(ev => {
      const city = (ev.venue?.city || '').toLowerCase();
      const region = (ev.venue?.region || '').toLowerCase();
      return city === 'new york' || city === 'brooklyn' || city === 'queens'
        || city === 'bronx' || city === 'staten island'
        || (region === 'ny' && /nyc|new york|manhattan|brooklyn|queens|hoboken|jersey city/i.test(
          `${ev.venue?.city} ${ev.venue?.name}`));
    }).map(ev => ({
      title: `${artistName} at ${ev.venue?.name || 'TBA'}`,
      artist: artistName,
      date: ev.datetime ? new Date(ev.datetime).toLocaleDateString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric'
      }) : '',
      dateRaw: ev.datetime || '',
      time: ev.datetime ? new Date(ev.datetime).toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit'
      }) : '',
      venue: ev.venue?.name || '',
      description: ev.description || `${artistName} live in NYC`,
      url: ev.url || '',
      imageUrl: ev.artist?.thumb_url || ev.artist?.image_url || '',
      source: 'bandsintown',
      type: 'music',
      lineup: ev.lineup || [artistName],
    }));
  } catch {
    return [];
  }
}

async function fetchAllConcerts() {
  const artists = profile.topArtists.slice(0, ARTIST_LIMIT);
  const events = [];
  let processed = 0;

  for (let i = 0; i < artists.length; i += ARTIST_BATCH_SIZE) {
    const batch = artists.slice(i, i + ARTIST_BATCH_SIZE);
    const results = await Promise.allSettled(batch.map(a => fetchArtistEvents(a.name)));

    for (const r of results) {
      if (r.status === 'fulfilled') events.push(...r.value);
    }

    processed = Math.min(i + ARTIST_BATCH_SIZE, artists.length);
    const pct = Math.round((processed / artists.length) * 100);
    progressFill.style.width = pct + '%';
    statusText.textContent = `Checking ${processed} of ${artists.length} artists for NYC shows...`;

    if (i + ARTIST_BATCH_SIZE < artists.length) {
      await new Promise(r => setTimeout(r, BATCH_DELAY_MS));
    }
  }

  // Deduplicate
  const seen = new Set();
  return events.filter(e => {
    const key = `${e.title.toLowerCase()}-${e.dateRaw}`;
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

// ── Rendering ───────────────────────────────────────────────────────
const gradients = [
  'linear-gradient(135deg, #667eea, #764ba2)',
  'linear-gradient(135deg, #f093fb, #f5576c)',
  'linear-gradient(135deg, #4facfe, #00f2fe)',
  'linear-gradient(135deg, #43e97b, #38f9d7)',
  'linear-gradient(135deg, #fa709a, #fee140)',
  'linear-gradient(135deg, #a18cd1, #fbc2eb)',
  'linear-gradient(135deg, #fccb90, #d57eeb)',
  'linear-gradient(135deg, #e0c3fc, #8ec5fc)',
  'linear-gradient(135deg, #f5576c, #ff6a88)',
  'linear-gradient(135deg, #667eea, #48c6ef)',
];

function hashStr(s) {
  let h = 0;
  for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; }
  return Math.abs(h);
}

function createCard(ev) {
  const card = document.createElement('a');
  card.className = 'event-card';
  card.href = ev.url || '#';
  card.target = '_blank';
  card.rel = 'noopener';
  card.dataset.type = ev.type || 'cultural';

  const grad = gradients[hashStr(ev.title) % gradients.length];
  const emoji = ev.type === 'music' ? '\u266B' : '\u25CA';
  const scorePct = Math.min((ev.score / 100) * 100, 100);

  const img = ev.imageUrl
    ? `<img class="card-image" src="${ev.imageUrl}" alt="" loading="lazy"
        onerror="this.outerHTML='<div class=\\'card-image placeholder\\' style=\\'background:${grad}\\'>${emoji}</div>'">`
    : `<div class="card-image placeholder" style="background:${grad}">${emoji}</div>`;

  const reasons = (ev.reasons || []).map(r => `<span class="reason-tag">${r}</span>`).join('');

  card.innerHTML = `
    ${img}
    <div class="card-body">
      <div class="card-meta">
        <span class="type-tag ${ev.type || 'cultural'}">${ev.type || 'event'}</span>
        <span class="card-date">${ev.date || ''}${ev.time ? ' &middot; ' + ev.time : ''}</span>
      </div>
      <h3 class="card-title">${ev.title}</h3>
      ${ev.venue ? `<p class="card-venue">${ev.venue}</p>` : ''}
      ${ev.description ? `<p class="card-description">${ev.description.slice(0, 150)}${ev.description.length > 150 ? '...' : ''}</p>` : ''}
    </div>
    <div class="card-footer">
      <div class="match-reasons">${reasons || '<span class="source-tag">Recommended</span>'}</div>
      <div class="score-bar"><div class="score-fill" style="width:${scorePct}%"></div></div>
    </div>`;

  return card;
}

function render(events) {
  grid.innerHTML = '';
  const filtered = currentFilter === 'all'
    ? events
    : events.filter(e => currentFilter === 'cultural' ? e.type !== 'music' : e.type === currentFilter);

  if (filtered.length === 0) {
    emptyState.style.display = 'block';
    return;
  }
  emptyState.style.display = 'none';
  for (const ev of filtered) grid.appendChild(createCard(ev));
}

// ── Main ────────────────────────────────────────────────────────────
async function loadEvents() {
  refreshBtn.classList.add('spinning');
  statusBar.classList.remove('hidden');
  progressFill.style.width = '0%';
  statusText.textContent = 'Loading your taste profile...';

  try {
    if (!profile) await loadProfile();

    statusText.textContent = 'Searching for concerts by your top artists...';
    const concerts = await fetchAllConcerts();

    allEvents = concerts
      .map(scoreEvent)
      .sort((a, b) => b.score - a.score);

    statusText.textContent = `Found ${allEvents.length} upcoming events in NYC`;
    progressFill.style.width = '100%';
    render(allEvents);

    // Fade out status bar after a moment
    setTimeout(() => { statusBar.classList.add('hidden'); }, 3000);
  } catch (err) {
    statusText.textContent = `Error: ${err.message}`;
  } finally {
    refreshBtn.classList.remove('spinning');
  }
}

// Filters
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelector('.filter-btn.active').classList.remove('active');
    btn.classList.add('active');
    currentFilter = btn.dataset.filter;
    render(allEvents);
  });
});

refreshBtn.addEventListener('click', () => loadEvents());
loadEvents();
</script>
</body>
</html>
